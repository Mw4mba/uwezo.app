
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users Collection
    // - Allow users to read their own data.
    // - Allow users to create their own user document upon signup.
    // - Allow users to update specific, non-critical fields in their own profile.
    match /users/{userId} {
      allow read, create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.keys().hasOnly(['firstName', 'lastName', 'displayName', 'photoURL', 'bio', 'linkedin', 'github', 'portfolio', 'credly', 'facebook', 'instagram', 'kickresume', 'whatsapp', 'updatedAt']);
    }

    // Quiz Attempts Sub-collection
    // - Allow users to create new quiz attempts under their own user document.
    // - Allow users to read their own past quiz attempts.
    match /users/{userId}/quizAttempts/{attemptId} {
      allow read, create: if request.auth != null && request.auth.uid == userId;
    }

    // Chats Collection
    // - A user can only read a chat document if their UID is in the 'participants' array.
    match /chats/{chatId} {
      allow read: if request.auth != null && request.auth.uid in resource.data.participants;

      // Messages Sub-collection
      // - A user can read/write messages in a chat if they are a participant.
      // - New messages must have the sender's correct UID.
      match /messages/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
                        && (request.method == 'create' ? request.resource.data.senderId == request.auth.uid : true);
      }
    }
  }
}
